version: '3.8'

services:
  dockhand:
    build: .
    image: izm1chael/dockhand:latest
    container_name: dockhand
    restart: unless-stopped
    environment:
      # Poll every 10 minutes (default)
      - DOCKHAND_POLL_INTERVAL=10m
      # Patch window: by default this is empty (always-on). To restrict updates to a safe time (e.g., midnight), set:
      # - DOCKHAND_PATCH_WINDOW=00:00-02:00
      # Only manage containers with :latest tag
      - DOCKHAND_MANAGE_LATEST_ONLY=true
      # Opt-out mode: manage all containers except those with dockhand.disable=true label
      - DOCKHAND_OPT_OUT=true
      # Notification level: all, failure, none
      - DOCKHAND_NOTIFICATION_LEVEL=all

      # --- Metrics (Optional) ---
      # Metrics are disabled by default (DOCKHAND_METRICS_ENABLED=false). Uncomment to enable the built-in metrics server.
      # - DOCKHAND_METRICS_ENABLED=true
      # - DOCKHAND_METRICS_PORT=9090

      # Influx (Optional: push historical metrics to InfluxDB v2)
      # - DOCKHAND_INFLUX_URL=http://influx:8086
      # - DOCKHAND_INFLUX_BUCKET=mybucket
      # - DOCKHAND_INFLUX_ORG=myorg
      # - DOCKHAND_INFLUX_TOKEN=secret

      # --- Notifications (Add your webhooks) ---
      # - DOCKHAND_GENERIC_WEBHOOK_URL=https://hooks.example.com/dockhand
      # - DOCKHAND_DISCORD_WEBHOOK=https://discord.com/api/webhooks/...
      # - DOCKHAND_SLACK_WEBHOOK=https://hooks.slack.com/services/...
      # - DOCKHAND_APPRISE_URL=https://apprise.example/send

      # Optional: dry-run or private registry auth
      # - DOCKHAND_DRY_RUN=false
      # - DOCKHAND_REGISTRY_USER=registryuser
      # - DOCKHAND_REGISTRY_PASS=secret
      # Path to the host Docker socket (when using a bind-mount). Set to /var/run/docker.sock when the
      # socket is mounted into the container. When using a TLS-protected Docker daemon over TCP,
      # point this to the TCP URL instead (e.g., tcp://dockerd:2376 or https://dockerd:2376).
      - DOCKHAND_HOST_SOCKET_PATH=/var/run/docker.sock

    volumes:
      # Mounting the host Docker socket into containers exposes the host and is a security risk.
      # Avoid bind-mounting /var/run/docker.sock when possible. If you must, explicitly set
      # the socket path via the DOCKHAND_HOST_SOCKET_PATH env var and restrict access.
      # Mount Docker socket so Dockhand can manage containers. This is required when Dockhand
      # needs direct access to the host Docker daemon. WARNING: bind-mounting the socket grants
      # the container equivalent access to the host and can be used for privilege escalation.
      - /var/run/docker.sock:/var/run/docker.sock

    # If you must mount the socket, reduce risk by:
    # - Running the container as a non-root user (`user: 1000`) where practical.
    # - Dropping unnecessary Linux capabilities: `cap_drop: - ALL` and only add those required.
    # - Using a Docker API over TLS instead of a socket mount when possible (configure dockerd
    #   to listen on a TLS-protected TCP socket and provide client certs to Dockhand).
    # Example (compose comments only):
    #   user: 1000
    #   cap_drop:
    #     - ALL
    #   cap_add:
    #     - CHOWN
    # Note: exposing the Docker socket is insecure. Prefer using the Docker API over TCP
    # secured with TLS, or run Dockhand with limited permissions and a dedicated service account.

    # Map port only if metrics are enabled (uncomment when enabling metrics)
    # ports:
    #   - "9090:9090"

